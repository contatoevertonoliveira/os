{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<style>
    /* Hide default radio inputs */
    input[name="technician_type"] {
        display: none;
    }
    
    /* Style for the labels acting as buttons */
    input[name="technician_type"]:checked + label {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    input[name="technician_type"] + label:hover {
        background-color: #e9ecef;
        border-color: #0d6efd;
        color: #0d6efd;
    }

    input[name="technician_type"]:checked + label:hover {
        background-color: #0b5ed7;
        color: white;
    }
</style>

<div class="container-fluid px-4">
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-9 col-md-10">
            <div class="card shadow-sm border-0 rounded-3 mt-4">
                <div class="card-header bg-white border-bottom pt-4 px-4 pb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0 fw-bold text-primary">{{ title }}</h5>
                        <p class="text-muted small mb-0">Preencha os dados do técnico.</p>
                    </div>
                    <a href="{{ back_url }}" class="btn btn-outline-secondary btn-sm px-3">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                </div>
                
                <div class="card-body px-4 py-4">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        <h6 class="text-secondary text-uppercase fw-bold small mb-3">
                            <i class="fas fa-id-card me-2"></i>Informações Pessoais
                        </h6>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label small fw-bold mb-1">Nome Completo</label>
                                {% render_field form.first_name class="form-control" placeholder="Ex: João da Silva" %}
                                <div class="text-danger small">{{ form.first_name.errors }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.username.id_for_label }}" class="form-label small fw-bold mb-1">Usuário de Acesso (Login)</label>
                                {% render_field form.username class="form-control" placeholder="Ex: joao.silva" %}
                                <div class="text-danger small">{{ form.username.errors }}</div>
                            </div>
                            <div class="col-12">
                                <label for="{{ form.email.id_for_label }}" class="form-label small fw-bold mb-1">Email</label>
                                {% render_field form.email class="form-control" placeholder="email@exemplo.com" %}
                                <div class="text-danger small">{{ form.email.errors }}</div>
                            </div>
                        </div>

                        <h6 class="text-secondary text-uppercase fw-bold small mb-3 border-top pt-3">
                            <i class="fas fa-briefcase me-2"></i>Dados Profissionais
                        </h6>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.job_title.id_for_label }}" class="form-label small fw-bold mb-1">Cargo / Função</label>
                                {% render_field form.job_title class="form-control" placeholder="Ex: Técnico Eletricista" %}
                                <div class="text-danger small">{{ form.job_title.errors }}</div>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.station.id_for_label }}" class="form-label small fw-bold mb-1">Posto de Alocação</label>
                                {% render_field form.station class="form-control" placeholder="Ex: Sede Principal" %}
                                <div class="text-danger small">{{ form.station.errors }}</div>
                            </div>
                            
                            <!-- Technician Type Switch -->
                            <div class="col-12">
                                <label class="form-label small fw-bold mb-1">Tipo de Atuação</label>
                                <div class="bg-light p-3 rounded border">
                                    <div class="d-flex gap-3 align-items-center mb-2">
                                        {% for radio in form.technician_type %}
                                            <div class="form-check form-check-inline m-0">
                                                {{ radio.tag }}
                                                <label class="btn btn-outline-primary btn-sm px-4" for="{{ radio.id_for_label }}">
                                                    {% if radio.data.value == 'fixo' %}
                                                        <i class="fas fa-map-marker-alt me-2"></i>Fixo
                                                    {% else %}
                                                        <i class="fas fa-route me-2"></i>Volante
                                                    {% endif %}
                                                </label>
                                            </div>
                                        {% endfor %}
                                        <div class="vr mx-2"></div>
                                        <small class="text-muted" id="techTypeHelp">
                                            <span class="d-none" data-type="fixo">Técnico alocado em posto específico.</span>
                                            <span class="d-none" data-type="volante">Técnico sem posto fixo, atende demandas variadas.</span>
                                        </small>
                                    </div>
                                    
                                    <!-- Fixed Location Selection -->
                                    <div id="fixedLocationFields" class="mt-3 border-top pt-3 d-none">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label for="{{ form.fixed_client.id_for_label }}" class="form-label small fw-bold mb-1">Empresa Vinculada</label>
                                                {% render_field form.fixed_client class="form-select" %}
                                                <div class="text-danger small">{{ form.fixed_client.errors }}</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="{{ form.fixed_hub.id_for_label }}" class="form-label small fw-bold mb-1">Hub/Loja (Opcional)</label>
                                                {% render_field form.fixed_hub class="form-select" %}
                                                <div class="text-danger small">{{ form.fixed_hub.errors }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-danger small">{{ form.technician_type.errors }}</div>
                            </div>

                            <div class="col-md-12">
                                <label for="{{ form.access_token.id_for_label }}" class="form-label small fw-bold mb-1">Token de Acesso (Login)</label>
                                {% render_field form.access_token class="form-control" placeholder="Token único para login" %}
                                <div class="text-muted small">{{ form.access_token.help_text }}</div>
                                <div class="text-danger small">{{ form.access_token.errors }}</div>
                            </div>
                            <div class="col-12">
                                <label for="{{ form.photo.id_for_label }}" class="form-label small fw-bold mb-1">Foto de Perfil</label>
                                {% render_field form.photo class="form-control" %}
                                <div class="text-danger small">{{ form.photo.errors }}</div>
                                {% if form.instance.profile.photo %}
                                <div class="mt-2">
                                    <img src="{{ form.instance.profile.photo.url }}" alt="Foto atual" class="img-thumbnail" style="height: 100px;">
                                    <p class="small text-muted">Foto atual</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <a href="{{ back_url }}" class="btn btn-light border px-4 btn-sm">Cancelar</a>
                            <button type="submit" class="btn btn-primary-custom px-5 btn-sm fw-bold">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const radios = document.querySelectorAll('input[name="technician_type"]');
        const helpTextSpans = document.querySelectorAll('#techTypeHelp span');
        const fixedLocationFields = document.getElementById('fixedLocationFields');
        
        // Hub Filtering Logic
        const clientSelect = document.getElementById('{{ form.fixed_client.id_for_label }}');
        const hubSelect = document.getElementById('{{ form.fixed_hub.id_for_label }}');
        
        // Build Hubs Data from Django Template
        const allHubs = [
            {% for hub in form.fields.fixed_hub.queryset %}
            {id: "{{ hub.id }}", name: "{{ hub.name|escapejs }}", client_id: "{{ hub.client.id }}"},
            {% endfor %}
        ];

        function filterHubs() {
            const selectedClientId = clientSelect.value;
            const currentHubId = hubSelect.value;
            
            // Clear current options (keep placeholder)
            hubSelect.innerHTML = '<option value="">Selecione o Hub (Se aplicável)</option>';
            
            if (!selectedClientId) {
                // If no client selected, show no hubs (or all? usually none until client selected)
                // Let's show none to be clean, or all if you prefer. 
                // Given the user wants to link, usually implies filtering.
                return;
            }

            const filteredHubs = allHubs.filter(h => h.client_id === selectedClientId);
            
            filteredHubs.forEach(hub => {
                const option = document.createElement('option');
                option.value = hub.id;
                option.textContent = hub.name;
                if (hub.id === currentHubId) {
                    option.selected = true;
                }
                hubSelect.appendChild(option);
            });
        }

        clientSelect.addEventListener('change', filterHubs);

        function updateTechTypeUI() {
            const checked = document.querySelector('input[name="technician_type"]:checked');
            if (checked) {
                const val = checked.value;
                
                // Update Help Text
                helpTextSpans.forEach(span => {
                    if (span.dataset.type === val) {
                        span.classList.remove('d-none');
                    } else {
                        span.classList.add('d-none');
                    }
                });

                // Update Fields Visibility
                if (val === 'fixo') {
                    fixedLocationFields.classList.remove('d-none');
                } else {
                    fixedLocationFields.classList.add('d-none');
                    // Optional: Clear selection when switching to Volante? 
                    // Better to keep it in case they switch back by mistake.
                }
            }
        }

        radios.forEach(radio => {
            radio.addEventListener('change', updateTechTypeUI);
        });

        // Initialize
        updateTechTypeUI();
        // Trigger filter on load to restore state (but wait, we need to preserve the initial selected hub)
        // The hubSelect.value will be populated by Django initially.
        // If we clear it, we lose the selection.
        // So we need to capture the initial value BEFORE clearing.
        const initialHubId = hubSelect.value;
        if (clientSelect.value) {
            filterHubs();
            if (initialHubId) {
                hubSelect.value = initialHubId;
            }
        }
    });
</script>
{% endblock %}