{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<style>
    /* Custom Switch Styles */
    .form-check-input.system-switch:checked {
        background-color: #26C45B;
        border-color: #26C45B;
        box-shadow: 0 0 8px rgba(38, 196, 91, 0.8);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
    }
    .form-check-input.system-switch:not(:checked) {
        background-color: #dc3545;
        border-color: #dc3545;
        opacity: 0.8;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
    }
    .form-check-input.system-switch:focus,
    .form-check-input.system-switch:active {
        outline: 0 !important;
        box-shadow: none !important;
    }
    .form-check-input.system-switch:checked:focus {
        border-color: #26C45B !important;
        background-color: #26C45B !important;
        box-shadow: 0 0 8px rgba(38, 196, 91, 0.8) !important;
    }
    .form-check-input.system-switch:not(:checked):focus {
        border-color: #dc3545 !important;
        background-color: #dc3545 !important;
        box-shadow: none !important;
    }
</style>
<div class="container-fluid px-4">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            <div class="card shadow-sm border-0 rounded-3 mt-4 mb-5">
                <div class="card-header bg-white border-bottom pt-4 px-4 pb-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0 fw-bold text-primary">{{ title }}</h5>
                        <p class="text-muted small mb-0">Preencha os dados abaixo para registrar a ordem de serviço.</p>
                    </div>
                    <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary btn-sm px-3">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                </div>
                
                <div class="card-body px-4 py-4">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        <!-- Seção 1: Informações Principais -->
                        <div class="mb-4">
                            <h6 class="text-secondary text-uppercase fw-bold small mb-3">
                                <i class="fas fa-info-circle me-2"></i>Informações Principais
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form.client.id_for_label }}" class="form-label small fw-bold mb-1">Cliente</label>
                                    {% render_field form.client class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.client.errors }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.hub.id_for_label }}" class="form-label small fw-bold mb-1">Hub / Loja</label>
                                    {% render_field form.hub class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.hub.errors }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.status.id_for_label }}" class="form-label small fw-bold mb-1">Status</label>
                                    {% render_field form.status class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.status.errors }}</div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-bold mb-1">Sistemas</label>
                                    <div class="card p-3 bg-light border rounded-3">
                                        <div class="d-flex flex-wrap gap-3">
                                            {% for checkbox in form.systems %}
                                            <div class="form-check form-switch">
                                                {{ checkbox.tag }}
                                                <label class="form-check-label d-flex align-items-center gap-2" for="{{ checkbox.id_for_label }}">
                                                    <span class="badge rounded-pill" id="badge-{{ checkbox.id_for_label }}" style="background-color: #6c757d; font-weight: normal; font-size: 0.8rem; min-width: 60px;">
                                                        {{ checkbox.choice_label }}
                                                    </span>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="text-danger small">{{ form.systems.errors }}</div>
                                    <small class="text-muted" style="font-size: 0.75rem;">Ative os switches para adicionar os sistemas à Ordem de Serviço.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 2: Localização e Classificação -->
                        <div class="mb-4">
                            <h6 class="text-secondary text-uppercase fw-bold small mb-3 border-top pt-3">
                                <i class="fas fa-map-marker-alt me-2"></i>Localização e Classificação
                            </h6>
                            <div class="row g-3">
                                <!-- Linha Localização -->
                                <div class="col-md-4">
                                    <label for="{{ form.area_group.id_for_label }}" class="form-label small fw-bold mb-1">Grupo de Área</label>
                                    {% render_field form.area_group class="form-control form-control-sm" placeholder="Ex: Bloco A" %}
                                    <div class="text-danger small">{{ form.area_group.errors }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.area_subgroup.id_for_label }}" class="form-label small fw-bold mb-1">Subgrupo</label>
                                    {% render_field form.area_subgroup class="form-control form-control-sm" placeholder="Ex: 1º Andar" %}
                                    <div class="text-danger small">{{ form.area_subgroup.errors }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.area.id_for_label }}" class="form-label small fw-bold mb-1">Área Específica</label>
                                    {% render_field form.area class="form-control form-control-sm" placeholder="Ex: Sala 101" %}
                                    <div class="text-danger small">{{ form.area.errors }}</div>
                                </div>

                                <!-- Linha Equipamento e Tipos -->
                                <div class="col-md-4">
                                    <label for="{{ form.equipment.id_for_label }}" class="form-label small fw-bold mb-1">Equipamento</label>
                                    {% render_field form.equipment class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.equipment.errors }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.call_type.id_for_label }}" class="form-label small fw-bold mb-1">Tipo de Chamado</label>
                                    {% render_field form.call_type class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.call_type.errors }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.problem_type.id_for_label }}" class="form-label small fw-bold mb-1">Tipo de Problema</label>
                                    {% render_field form.problem_type class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.problem_type.errors }}</div>
                                </div>
                                
                                <!-- Oculto (Legacy) -->
                                <div class="d-none">
                                    {% render_field form.order_type %}
                                </div>
                            </div>
                        </div>

                        <!-- Seção 3: Responsáveis e Prazo -->
                        <div class="mb-4">
                            <h6 class="text-secondary text-uppercase fw-bold small mb-3 border-top pt-3">
                                <i class="fas fa-users me-2"></i>Responsáveis e Prazo
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="{{ form.requester.id_for_label }}" class="form-label small fw-bold mb-1">Solicitante</label>
                                    {% render_field form.requester class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.requester.errors }}</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form.technicians.id_for_label }}" class="form-label small fw-bold mb-1">Técnicos Responsáveis</label>
                                    {% render_field form.technicians class="form-select form-select-sm" %}
                                    <div class="text-danger small">{{ form.technicians.errors }}</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form.start_date.id_for_label }}" class="form-label small fw-bold mb-1">Data de Início</label>
                                    {% render_field form.start_date class="form-control form-control-sm" type="date" %}
                                    <div class="text-danger small">{{ form.start_date.errors }}</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form.deadline.id_for_label }}" class="form-label small fw-bold mb-1">Data Limite (Deadline)</label>
                                    {% render_field form.deadline class="form-control form-control-sm" type="date" %}
                                    <div class="text-danger small">{{ form.deadline.errors }}</div>
                                </div>
                                {% if form.finished_at %}
                                <div class="col-md-4 mt-3">
                                    <label for="{{ form.finished_at.id_for_label }}" class="form-label small fw-bold mb-1">Data de Finalização</label>
                                    {% render_field form.finished_at class="form-control form-control-sm" type="datetime-local" %}
                                    <div class="text-danger small">{{ form.finished_at.errors }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Seção 4: Detalhamento -->
                        <div class="mb-4">
                            <h6 class="text-secondary text-uppercase fw-bold small mb-3 border-top pt-3">
                                <i class="fas fa-align-left me-2"></i>Detalhamento
                            </h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="{{ form.description.id_for_label }}" class="form-label small fw-bold mb-1">{{ form.description.label }}</label>
                                    {% render_field form.description class="form-control" rows="4" placeholder="Descreva os detalhes da solicitação..." %}
                                    <div class="text-danger small">{{ form.description.errors }}</div>
                                </div>
                                {% if form.instance.pk %}
                                <div class="col-12">
                                    <label for="{{ form.final_description.id_for_label }}" class="form-label small fw-bold mb-1">Descrição Final (Resolução)</label>
                                    {% render_field form.final_description class="form-control" rows="4" placeholder="Descreva o que foi feito para resolver o problema e finalizar a ocorrência..." %}
                                    <div class="text-danger small">{{ form.final_description.errors }}</div>
                                </div>
                                {% endif %}
                                <div class="col-12">
                                    <label for="{{ form.image.id_for_label }}" class="form-label small fw-bold mb-1">Imagem / Anexo</label>
                                    {% render_field form.image class="form-control form-control-sm" %}
                                    <div class="text-danger small">{{ form.image.errors }}</div>
                                    {% if form.instance.image %}
                                        <div class="mt-2">
                                            <small class="text-muted">Imagem Atual:</small><br>
                                            <img src="{{ form.instance.image.url }}" alt="Imagem do Ticket" class="img-thumbnail" style="max-height: 100px;">
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <a href="{{ back_url }}" class="btn btn-light border px-4 btn-sm">Cancelar</a>
                            <button type="submit" class="btn btn-primary-custom px-5 btn-sm fw-bold">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            {% if updates %}
            <!-- Histórico de Evoluções (Apenas na Edição) -->
            <div class="card shadow-sm border-0 rounded-3 mb-5">
                <div class="card-header bg-white border-bottom pt-4 px-4 pb-3">
                    <h5 class="mb-0 fw-bold text-primary">Histórico de Evoluções</h5>
                </div>
                <div class="card-body px-4 py-4">
                    <div class="timeline">
                        {% for update in updates %}
                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0 me-3">
                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-comment-dots text-primary"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h6 class="mb-0 fw-bold">{{ update.created_by.get_full_name|default:update.created_by.username }}</h6>
                                    <small class="text-muted">{{ update.created_at|date:"d/m/Y H:i" }}</small>
                                </div>
                                <p class="mb-2 text-secondary">{{ update.description }}</p>
                                {% if update.images.exists %}
                                    <div class="d-flex flex-wrap gap-2 mt-2">
                                        {% for img_obj in update.images.all %}
                                            <div class="position-relative d-inline-block">
                                                <img src="{{ img_obj.image.url }}" 
                                                     alt="Imagem da Evolução" 
                                                     class="img-thumbnail open-gallery-btn shadow-sm" 
                                                     style="width: 100px; height: 100px; object-fit: cover; cursor: pointer; transition: transform 0.2s;"
                                                     onmouseover="this.style.transform='scale(1.05)'"
                                                     onmouseout="this.style.transform='scale(1)'"
                                                     data-image-url="{{ img_obj.image.url }}"
                                                     data-image-desc="{{ update.description|default:''|escapejs }}">
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif update.image %}
                                    <div class="mt-2">
                                        <img src="{{ update.image.url }}" 
                                             alt="Imagem da Evolução" 
                                             class="img-thumbnail open-gallery-btn shadow-sm" 
                                             style="width: 100px; height: 100px; object-fit: cover; cursor: pointer; transition: transform 0.2s;"
                                             onmouseover="this.style.transform='scale(1.05)'"
                                             onmouseout="this.style.transform='scale(1)'"
                                             data-image-url="{{ update.image.url }}"
                                             data-image-desc="{{ update.description|default:''|escapejs }}">
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.getElementById('id_start_date');
        const deadlineInput = document.getElementById('id_deadline');
        const estimatedTimeInput = document.getElementById('id_estimated_time');

        function calculateEstimatedTime() {
            if (startDateInput.value && deadlineInput.value) {
                const start = new Date(startDateInput.value + 'T00:00:00');
                const end = new Date(deadlineInput.value + 'T00:00:00');
                
                // Calculate difference in milliseconds
                const diffTime = end - start;
                // Convert to days (add 1 to include both start and end dates)
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 

                if (diffDays > 0) {
                    // 8 hours 48 minutes per day = 528 minutes per day
                    const minutesPerDay = 528;
                    const totalMinutes = diffDays * minutesPerDay;
                    
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    
                    // Format: HH:MM:00
                    const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')}:00`;
                    estimatedTimeInput.value = formattedTime;
                } else {
                    // If end date is before start date, do nothing or clear? 
                    // Let's clear to avoid confusion
                    estimatedTimeInput.value = '';
                }
            }
        }

        if (startDateInput && deadlineInput && estimatedTimeInput) {
            startDateInput.addEventListener('change', calculateEstimatedTime);
            deadlineInput.addEventListener('change', calculateEstimatedTime);
        }

        // Dynamic Hub Loading
        const clientSelect = document.getElementById('id_client');
        const hubSelect = document.getElementById('id_hub');
        const hubUrl = "{% url 'ajax_load_hubs' %}";

        if (clientSelect && hubSelect) {
            clientSelect.addEventListener('change', function() {
                const clientId = this.value;
                
                // Clear existing options
                hubSelect.innerHTML = '<option value="">---------</option>';
                
                if (clientId) {
                    fetch(`${hubUrl}?client_id=${clientId}`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(hub => {
                                const option = document.createElement('option');
                                option.value = hub.id;
                                option.textContent = hub.name;
                                hubSelect.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error loading hubs:', error));
                }
            });
        }
    });
</script>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Define colors from template
        const systemColors = {
            {% for system in form.systems.field.queryset %}
                "{{ system.id }}": "{{ system.color }}",
            {% endfor %}
        };

        // Update badge visibility/opacity based on switch state
        const checkboxes = document.querySelectorAll('input[name="systems"]');
        
        checkboxes.forEach(checkbox => {
            const badge = document.getElementById(`badge-${checkbox.id}`);
            const systemId = checkbox.value;
            const color = systemColors[systemId] || '#6c757d';
            
            // Set initial color
            if (badge) {
                badge.style.backgroundColor = color;
                
                // Function to update style
                const updateStyle = () => {
                    if (checkbox.checked) {
                        badge.style.opacity = '1';
                        badge.classList.add('shadow-sm');
                    } else {
                        badge.style.opacity = '0.5';
                        badge.classList.remove('shadow-sm');
                    }
                };

                // Add listener
                checkbox.addEventListener('change', updateStyle);
                
                // Initial call
                updateStyle();
            }
        });
    });
</script>