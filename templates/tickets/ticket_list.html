{% extends 'base.html' %}

{% block content %}
<style>
    .row-finished { background-color: rgba(25, 135, 84, 0.1); }
    .row-pending { background-color: rgba(255, 193, 7, 0.1); }
    .row-canceled { background-color: rgba(220, 53, 69, 0.1); }
    .row-in-progress { background-color: rgba(13, 110, 253, 0.1); }
    
    .ticket-row { transition: background-color 0.2s; }
</style>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Ordens de Serviço</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'ticket_create' %}" class="btn btn-primary-custom">
            <i class="fas fa-plus"></i> Nova OS
        </a>
    </div>
</div>

<div class="card card-custom">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Cliente</th>
                        <th>Tipo de Chamado</th>
                        <th>Equipamento</th>
                        <th>Técnico</th>
                        <th>Status</th>
                        <th>Data Criação</th>
                        <th>Última Atualização</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ticket in tickets %}
                    <tr class="ticket-row {% if ticket.status == 'finished' %}row-finished{% elif ticket.status == 'pending' %}row-pending{% elif ticket.status == 'canceled' %}row-canceled{% elif ticket.status == 'in_progress' %}row-in-progress{% else %}row-open{% endif %}"
                        style="cursor: pointer;"
                        data-ticket-id="{{ ticket.id }}">
                        <td>{{ ticket.formatted_id }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if ticket.client.logo %}
                                    <img src="{{ ticket.client.logo.url }}" alt="Logo" class="me-2 rounded" style="width: 24px; height: 24px; object-fit: cover;">
                                {% endif %}
                                {{ ticket.client.name }}
                            </div>
                        </td>
                        <td>{{ ticket.get_call_type_display|default:"-" }}</td>
                        <td>
                            {% if ticket.equipments.exists %}
                                {% for eq in ticket.equipments.all %}
                                    {{ eq.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                {{ ticket.equipment|default:"-" }}
                            {% endif %}
                        </td>
                        <td>
                            {% for tech in ticket.technicians.all %}
                                <div>{{ tech.get_full_name|default:tech.username }}</div>
                            {% empty %}
                                <span class="text-muted">-</span>
                            {% endfor %}
                        </td>
                        <td>
                            <span class="badge badge-{{ ticket.status }}">
                                {{ ticket.get_status_display }}
                            </span>
                        </td>
                        <td>{{ ticket.created_at|date:"d/m/Y H:i" }}</td>
                        <td>{{ ticket.updated_at|date:"d/m/Y H:i" }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-info view-ticket-btn" title="Ver/Editar Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if request.user.profile.role == 'admin' or request.user.profile.role == 'super_admin' %}
                            <button type="button" class="btn btn-sm btn-outline-danger" title="Excluir" onclick="event.stopPropagation(); confirmDelete('{% url 'ticket_delete' ticket.id %}', 'OS #{{ ticket.formatted_id|escapejs }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center py-4">Nenhuma ordem de serviço encontrada.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="ticketDockContainer" class="position-fixed bottom-0 p-2 d-flex flex-column-reverse gap-2" style="z-index: 1080; pointer-events: none; max-height: 80vh; overflow-y: auto; scrollbar-width: none;">
    <!-- Dock items will be injected here -->
</div>

<!-- Dynamic Ticket Modal Container -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" id="ticketModalContent">
            <!-- Content loaded via AJAX -->
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .resizer {
        position: absolute;
        background-color: transparent;
        z-index: 100;
    }
    .resizer-se {
        width: 15px;
        height: 15px;
        bottom: 0;
        right: 0;
        cursor: se-resize;
    }
    .resizer-e {
        width: 5px;
        height: 100%;
        top: 0;
        right: 0;
        cursor: e-resize;
    }
    .resizer-s {
        height: 5px;
        width: 100%;
        bottom: 0;
        left: 0;
        cursor: s-resize;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ticketModalElement = document.getElementById('ticketModal');
        const ticketModal = new bootstrap.Modal(ticketModalElement);
        const modalContent = document.getElementById('ticketModalContent');
        const dockContainer = document.getElementById('ticketDockContainer');

        // State Management
        const openTickets = new Map(); // id -> { html, dialogClass, dialogStyle, title }
        let activeTicketId = null;
        let ticketsUpdated = false;
        const STORAGE_KEY = 'OS_SYSTEM_OPEN_TICKETS';

        // --- Persistence Logic ---

        function saveToStorage() {
            try {
                if (activeTicketId) {
                    saveCurrentTicketState();
                }
                const ticketsArray = Array.from(openTickets.entries());
                localStorage.setItem(STORAGE_KEY, JSON.stringify(ticketsArray));
            } catch (e) {
                console.warn('Failed to save tickets to localStorage:', e);
            }
        }

        function loadFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const ticketsArray = JSON.parse(stored);
                    openTickets.clear();
                    ticketsArray.forEach(([id, state]) => {
                        openTickets.set(id, state);
                    });
                    renderDock();
                }
            } catch (e) {
                console.warn('Failed to load tickets from localStorage:', e);
            }
        }

        window.addEventListener('beforeunload', () => {
             // Ensure current active ticket is saved to state before unloading
             if (activeTicketId) {
                 saveCurrentTicketState();
             }
             saveToStorage();
        });

        // --- Helper Functions ---

        window.toggleEditUpdate = function(id) {
            const viewDiv = document.getElementById(`update-view-${id}`);
            const editDiv = document.getElementById(`update-edit-${id}`);
            
            if (viewDiv && editDiv) {
                if (editDiv.classList.contains('d-none')) {
                    editDiv.classList.remove('d-none');
                    viewDiv.classList.add('d-none');
                } else {
                    editDiv.classList.add('d-none');
                    viewDiv.classList.remove('d-none');
                }
            }
        };

        function executeScripts(container) {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                Array.from(script.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                newScript.appendChild(document.createTextNode(script.innerHTML));
                script.parentNode.replaceChild(newScript, script);
            });
        }

        function formatTicketId(id) {
            return `JMP${String(id).padStart(5, '0')}`;
        }

        function getMainContentEl() {
            return document.querySelector('.main-content') || document.body;
        }

        function getDialog() {
            return ticketModalElement.querySelector('.modal-dialog');
        }

        function setDialogFullscreen(isFullscreen) {
            const dialog = getDialog();
            if (!dialog) return;
            if (isFullscreen) {
                dialog.classList.add('modal-fullscreen');
                dialog.classList.remove('modal-xl');
            } else {
                dialog.classList.remove('modal-fullscreen');
                dialog.classList.add('modal-xl');
            }
        }

        function isDialogFullscreen() {
            const dialog = getDialog();
            if (!dialog) return false;
            return dialog.classList.contains('modal-fullscreen');
        }

        // --- Dock Management ---

        function renderDock() {
            dockContainer.innerHTML = '';
            
            const mainContent = getMainContentEl();
            const rect = mainContent.getBoundingClientRect();
            dockContainer.style.left = `${rect.left}px`;
            // For vertical stack, we don't set fixed width, but we might want to ensure it doesn't overlap too much.
            // But user asked for "block in footer". 
            // If vertical stack, it grows up from bottom-left of main content.
            
            openTickets.forEach((state, id) => {
                // Show in dock if NOT active (minimized)
                if (id === activeTicketId) return;

                const item = document.createElement('div');
                item.className = 'card shadow-sm border-primary ticket-dock-item mb-0';
                item.style.cssText = 'width: 220px; min-width: 220px; cursor: pointer; pointer-events: auto; opacity: 0.95; transition: transform 0.2s;';
                item.setAttribute('data-ticket-id', id);
                item.innerHTML = `
                    <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2 text-truncate" style="max-width: 160px;">
                            <i class="fas fa-window-restore text-primary"></i>
                            <div class="d-flex flex-column" style="line-height: 1.1;">
                                <span class="fw-bold small text-truncate">${formatTicketId(id)}</span>
                                <span class="small text-muted text-truncate" style="font-size: 0.75rem;" title="${state.title}">${state.title.replace(/^OS JMP\d+\s*/, '')}</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close btn-close-sm ms-2 close-dock-btn" aria-label="Close"></button>
                    </div>
                `;
                
                // Hover effect
                item.addEventListener('mouseenter', () => item.style.transform = 'translateX(5px)');
                item.addEventListener('mouseleave', () => item.style.transform = 'translateX(0)');

                item.addEventListener('click', (e) => {
                    if (e.target.closest('.close-dock-btn')) return;
                    restoreTicket(id);
                });

                item.querySelector('.close-dock-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTicket(id);
                });

                dockContainer.appendChild(item);
            });
        }

        // --- Ticket Management ---

        function saveCurrentTicketState() {
            if (!activeTicketId) return;
            const dialog = getDialog();
            const titleEl = modalContent.querySelector('.modal-title');
            const title = titleEl ? titleEl.textContent : `OS ${formatTicketId(activeTicketId)}`;
            
            // Sync values to attributes for HTML serialization
            modalContent.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    if (input.checked) input.setAttribute('checked', 'checked');
                    else input.removeAttribute('checked');
                } else {
                    input.setAttribute('value', input.value);
                    if (input.tagName === 'TEXTAREA') input.textContent = input.value;
                    if (input.tagName === 'SELECT') {
                        Array.from(input.options).forEach(opt => {
                            if (opt.selected) opt.setAttribute('selected', 'selected');
                            else opt.removeAttribute('selected');
                        });
                    }
                }
            });

            openTickets.set(activeTicketId, {
                html: modalContent.innerHTML,
                dialogClass: dialog ? dialog.className : 'modal-dialog modal-xl',
                dialogStyle: dialog ? dialog.getAttribute('style') : '',
                title: title
            });
        }

        function closeTicket(id) {
            if (activeTicketId === id) {
                activeTicketId = null;
                ticketModal.hide();
            }
            openTickets.delete(id);
            renderDock();
            saveToStorage();
            if (ticketsUpdated) refreshTicketList();
        }

        function minimizeCurrentTicket() {
            if (!activeTicketId) return;
            saveCurrentTicketState();
            activeTicketId = null;
            ticketModal.hide();
            renderDock();
            saveToStorage();
        }

        function restoreTicket(id) {
            if (activeTicketId === id) return;

            if (activeTicketId) {
                saveCurrentTicketState();
            }

            const state = openTickets.get(id);
            if (!state) return;

            activeTicketId = id;
            modalContent.innerHTML = state.html;
            
            const dialog = getDialog();
            if (dialog) {
                dialog.className = state.dialogClass;
                if (state.dialogStyle) dialog.setAttribute('style', state.dialogStyle);
                else dialog.removeAttribute('style');
            }

            ensureModalHandlersBound();
            ticketModal.show();
            renderDock();
            saveToStorage();
        }

        function loadTicketModal(ticketId) {
            if (openTickets.has(ticketId)) {
                restoreTicket(ticketId);
                return;
            }

            if (activeTicketId) {
                saveCurrentTicketState();
            }

            activeTicketId = ticketId;
            renderDock();

            modalContent.innerHTML = `
                <div class="modal-body text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            `;
            const dialog = getDialog();
            if (dialog) {
                dialog.className = 'modal-dialog modal-xl';
                dialog.removeAttribute('style');
            }
            
            ticketModal.show();

            fetch(`/tickets/${ticketId}/modal/`)
                .then(response => response.text())
                .then(html => {
                    modalContent.innerHTML = html;
                    
                    const titleEl = modalContent.querySelector('.modal-title');
                    const title = titleEl ? titleEl.textContent : `OS ${formatTicketId(ticketId)}`;
                    openTickets.set(ticketId, {
                        html: html,
                        dialogClass: 'modal-dialog modal-xl',
                        dialogStyle: '',
                        title: title
                    });
                    
                    executeScripts(modalContent);
                    ensureModalHandlersBound();
                    saveToStorage();
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalContent.innerHTML = '<div class="modal-body text-danger">Erro ao carregar.</div>';
                });
        }

        function refreshTicketList() {
            fetch(window.location.href)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newTbody = doc.querySelector('table tbody');
                    const currentTbody = document.querySelector('table tbody');
                    if (newTbody && currentTbody) {
                        currentTbody.innerHTML = newTbody.innerHTML;
                        bindTableEvents();
                    }
                    ticketsUpdated = false;
                });
        }

        // --- Event Handlers & Binding ---

        ticketModalElement.addEventListener('hidden.bs.modal', function () {
            if (activeTicketId) {
                closeTicket(activeTicketId);
            }
        });

        function bindTableEvents() {
            document.querySelectorAll('.ticket-row').forEach(row => {
                row.addEventListener('dblclick', function() {
                    const ticketId = this.getAttribute('data-ticket-id');
                    loadTicketModal(ticketId);
                });
            });

            document.querySelectorAll('.view-ticket-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const row = this.closest('tr');
                    const ticketId = row.getAttribute('data-ticket-id');
                    loadTicketModal(ticketId);
                });
            });
        }

        bindTableEvents();
        window.addEventListener('resize', () => {
             if (dockContainer.children.length > 0) renderDock();
        });
        
        // Initialize from storage
        loadFromStorage();
        
        // --- Form Handling & Drag & Resize ---

        function getForm() { return modalContent.querySelector('#ticketEditForm'); }
        function getFieldFromToggle(toggleBtn) {
            const inputGroup = toggleBtn.closest('.input-group');
            return inputGroup ? inputGroup.querySelector('input, select, textarea') : null;
        }
        function showToggleForField(field) {
            const inputGroup = field.closest('.input-group');
            const toggleBtn = inputGroup ? inputGroup.querySelector('.edit-toggle') : null;
            if (toggleBtn) toggleBtn.style.display = 'block';
        }
        function lockField(field) {
            field.setAttribute('disabled', 'disabled');
            field.classList.add('form-control-plaintext');
            field.classList.remove('form-control');
            if (field.tagName === 'SELECT') field.classList.remove('form-select');
        }
        function unlockField(field) {
            field.removeAttribute('disabled');
            field.removeAttribute('readonly');
            field.classList.remove('form-control-plaintext');
            field.classList.add('form-control');
            if (field.tagName === 'SELECT') field.classList.add('form-select');
        }

        function submitTicketForm(isAutoSave, submitter) {
            const form = getForm();
            if (!form) return;

            const evoDescInput = form.querySelector('textarea[name="evolution_description"]');
            const evoDescValue = evoDescInput ? evoDescInput.value : '';

            const disabledInputs = Array.from(form.querySelectorAll(':disabled'));
            disabledInputs.forEach(input => input.removeAttribute('disabled'));

            const formData = new FormData(form);
            
            // Add submitter button if present
            if (submitter && submitter.name) {
                formData.append(submitter.name, submitter.value);
            }

            const actionUrl = form.getAttribute('action');

            disabledInputs.forEach(input => input.setAttribute('disabled', 'disabled'));

            if (isAutoSave) {
                formData.delete('evolution_description');
                formData.delete('evolution_image');
            }

            fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                return response.text().then(html => {
                    modalContent.innerHTML = html;
                    ticketsUpdated = true;
                    if (isAutoSave && evoDescValue) {
                        const newEvoInput = modalContent.querySelector('textarea[name="evolution_description"]');
                        if (newEvoInput) newEvoInput.value = evoDescValue;
                    }
                    if (activeTicketId) {
                         const titleEl = modalContent.querySelector('.modal-title');
                         const title = titleEl ? titleEl.textContent : `OS ${formatTicketId(activeTicketId)}`;
                         const state = openTickets.get(activeTicketId);
                         if (state) {
                             state.html = html;
                             state.title = title;
                         }
                    }

                    executeScripts(modalContent);

                    if (!isAutoSave) {
                        const toastContainer = document.querySelector('.toast-container');
                        if (toastContainer) {
                            const toast = document.createElement('div');
                            toast.className = 'toast align-items-center text-white bg-success border-0';
                            toast.role = 'alert';
                            toast.ariaLive = 'assertive';
                            toast.ariaAtomic = 'true';
                            toast.innerHTML = `
                                <div class="d-flex">
                                    <div class="toast-body">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Ordem de Serviço atualizada com sucesso!
                                    </div>
                                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                            `;
                            toastContainer.appendChild(toast);
                            const bsToast = new bootstrap.Toast(toast);
                            bsToast.show();
                            
                            toast.addEventListener('hidden.bs.toast', () => {
                                toast.remove();
                            });
                        }
                    }

                    ensureModalHandlersBound();
                    saveToStorage();
                });
            })
            .catch(() => {
                alert('Erro ao salvar as alterações. Tente novamente.');
            });
        }

        function ensureModalHandlersBound() {
            if (modalContent.dataset.handlersBound === '1') return;
            modalContent.dataset.handlersBound = '1';

            // Drag Variables
            let isDraggingModal = false;
            let dragStartX = 0, dragStartY = 0;
            let dialogStartLeft = 0, dialogStartTop = 0;

            // Resize Variables
            let isResizing = false;
            let currentResizer = null;
            let originalWidth = 0;
            let originalHeight = 0;
            let originalX = 0;
            let originalY = 0;
            let originalMouseX = 0;
            let originalMouseY = 0;

            // --- Drag Logic ---
            function startDrag(e) {
                if (e.button !== 0) return;
                // Ignore if clicking on a resizer
                if (e.target.classList.contains('resizer')) return;
                
                const header = e.target.closest('.modal-header');
                if (!header || !modalContent.contains(header)) return;
                if (e.target.closest('button, a, input, select, textarea')) return;
                if (isDialogFullscreen()) return;

                const dialog = getDialog();
                if (!dialog) return;

                const rect = dialog.getBoundingClientRect();
                dialog.style.position = 'fixed';
                dialog.style.margin = '0';
                dialog.style.left = `${rect.left}px`;
                dialog.style.top = `${rect.top}px`;
                dialog.style.width = `${rect.width}px`;
                dialog.style.maxWidth = `${rect.width}px`; // Force fixed width to prevent auto-resize

                isDraggingModal = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                dialogStartLeft = rect.left;
                dialogStartTop = rect.top;
                document.body.style.userSelect = 'none';
                header.style.cursor = 'grabbing';
            }

            function onDragMove(e) {
                if (isDraggingModal) {
                    const dialog = getDialog();
                    if (!dialog) return;

                    const dx = e.clientX - dragStartX;
                    const dy = e.clientY - dragStartY;
                    dialog.style.left = `${dialogStartLeft + dx}px`;
                    dialog.style.top = `${dialogStartTop + dy}px`;
                } else if (isResizing) {
                    const dialog = getDialog();
                    if (!dialog) return;
                    
                    if (currentResizer.classList.contains('resizer-se')) {
                        const width = originalWidth + (e.clientX - originalMouseX);
                        const height = originalHeight + (e.clientY - originalMouseY);
                        if (width > 300) dialog.style.width = `${width}px`;
                        if (width > 300) dialog.style.maxWidth = `${width}px`;
                        // Note: Height in bootstrap modal is driven by content, but we can set min-height or height
                        // For height resize to work, we might need to set height on modal-content or body
                        // Let's set height on .modal-content
                        if (height > 200) modalContent.style.height = `${height}px`;
                    } else if (currentResizer.classList.contains('resizer-e')) {
                        const width = originalWidth + (e.clientX - originalMouseX);
                        if (width > 300) dialog.style.width = `${width}px`;
                        if (width > 300) dialog.style.maxWidth = `${width}px`;
                    } else if (currentResizer.classList.contains('resizer-s')) {
                         const height = originalHeight + (e.clientY - originalMouseY);
                         if (height > 200) modalContent.style.height = `${height}px`;
                    }
                }
            }

            function endDrag() {
                if (isDraggingModal) {
                    isDraggingModal = false;
                    document.body.style.userSelect = '';
                    const header = modalContent.querySelector('.modal-header');
                    if (header) header.style.cursor = 'move';
                }
                if (isResizing) {
                    isResizing = false;
                    document.body.style.userSelect = '';
                }
            }

            // --- Resize Logic ---
            function initResize() {
                const dialog = getDialog();
                if (!dialog) return;
                
                // Add resizers if not present
                if (!dialog.querySelector('.resizer')) {
                    const resizerSE = document.createElement('div');
                    resizerSE.className = 'resizer resizer-se';
                    dialog.appendChild(resizerSE);

                    const resizerE = document.createElement('div');
                    resizerE.className = 'resizer resizer-e';
                    dialog.appendChild(resizerE);

                    const resizerS = document.createElement('div');
                    resizerS.className = 'resizer resizer-s';
                    dialog.appendChild(resizerS);
                    
                    // Attach events to resizers
                    [resizerSE, resizerE, resizerS].forEach(el => {
                        el.addEventListener('mousedown', function(e) {
                            if (e.button !== 0) return;
                            e.stopPropagation(); // Prevent drag
                            isResizing = true;
                            currentResizer = el;
                            originalMouseX = e.clientX;
                            originalMouseY = e.clientY;
                            
                            const rect = dialog.getBoundingClientRect();
                            originalWidth = rect.width;
                            originalHeight = modalContent.getBoundingClientRect().height; // Resize content height
                            originalX = rect.left;
                            originalY = rect.top;
                            
                            document.body.style.userSelect = 'none';
                        });
                    });
                }
            }
            
            // Initialize resize handles
            initResize();

            modalContent.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', endDrag);

            modalContent.addEventListener('click', function(e) {
                const minimizeBtn = e.target.closest('.modal-minimize-btn');
                if (minimizeBtn && modalContent.contains(minimizeBtn)) {
                    e.preventDefault();
                    minimizeCurrentTicket();
                    return;
                }

                const maximizeBtn = e.target.closest('.modal-maximize-btn');
                if (maximizeBtn && modalContent.contains(maximizeBtn)) {
                    e.preventDefault();
                    const nextState = !isDialogFullscreen();
                    if (nextState) {
                        const dialog = getDialog();
                        if (dialog) dialog.removeAttribute('style');
                        modalContent.style.height = ''; // Reset height
                    }
                    setDialogFullscreen(nextState);
                    const icon = maximizeBtn.querySelector('i');
                    if (icon) icon.className = nextState ? 'far fa-window-restore' : 'far fa-window-maximize';
                    maximizeBtn.title = nextState ? 'Restaurar tamanho' : 'Maximizar';
                    
                    const header = modalContent.querySelector('.modal-header');
                    if (header) header.style.cursor = nextState ? 'default' : 'move';
                    return;
                }

                const toggleBtn = e.target.closest('.edit-toggle');
                if (toggleBtn && modalContent.contains(toggleBtn)) {
                    e.preventDefault();
                    const field = getFieldFromToggle(toggleBtn);
                    if (field) {
                        unlockField(field);
                        field.dataset.originalValue = field.value;
                        toggleBtn.style.display = 'none';
                        field.focus();
                    }
                }
            });

            modalContent.addEventListener('focusout', function(e) {
                const field = e.target;
                if (!modalContent.contains(field)) return;
                if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(field.tagName)) return;
                const name = field.getAttribute('name') || '';
                if (name === 'evolution_description' || name === 'evolution_image') return;
                if (field.dataset.originalValue === undefined) return;

                if (field.value !== field.dataset.originalValue) {
                    lockField(field);
                    showToggleForField(field);
                    submitTicketForm(true);
                    return;
                }
                if (!field.hasAttribute('disabled')) {
                    lockField(field);
                    showToggleForField(field);
                }
            });

            modalContent.addEventListener('keydown', function(e) {
                const field = e.target;
                if (modalContent.contains(field) && ['INPUT', 'SELECT'].includes(field.tagName) && e.key === 'Enter') {
                    e.preventDefault();
                    field.blur();
                }
            });

            modalContent.addEventListener('submit', function(e) {
                if (e.target.id === 'ticketEditForm') {
                    e.preventDefault();
                    submitTicketForm(false, e.submitter);
                } else if (e.target.classList.contains('update-edit-form') || e.target.classList.contains('update-delete-form')) {
                    e.preventDefault();
                    
                    const form = e.target;
                    const formData = new FormData(form);
                    const url = form.action;
                    
                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                        }
                    })
                    .then(response => response.text())
                    .then(html => {
                        modalContent.innerHTML = html;
                        executeScripts(modalContent);
                        
                        // Update state if needed
                        if (activeTicketId) {
                             const state = openTickets.get(activeTicketId);
                             if (state) {
                                 state.html = html;
                             }
                        }
                    })
                    .catch(err => console.error(err));
                }
            });
        }
    });
</script>
{% endblock %}
