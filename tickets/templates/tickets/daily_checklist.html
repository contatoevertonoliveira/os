{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 text-gray-800"><i class="fas fa-tasks me-2"></i>Checklist Diário</h2>
            <p class="text-muted mb-0">
                <i class="far fa-calendar me-1"></i> {% now "d/m/Y" %}
                <span class="mx-2">|</span>
                <i class="fas fa-user me-1"></i> {{ request.user.get_full_name|default:request.user.username }}
            </p>
        </div>
        <div>
            <a href="{% url 'checklist_pdf' %}" class="btn btn-danger shadow-sm">
                <i class="fas fa-file-pdf me-2"></i>Exportar PDF
            </a>
        </div>
    </div>

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-4" id="checklistTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="true">
                <i class="fas fa-list-check me-2"></i>Checklist Diário
            </button>
        </li>
    </ul>

    <div class="tab-content" id="checklistTabsContent">
        <!-- Daily Tab -->
        <div class="tab-pane fade show active" id="daily" role="tabpanel" aria-labelledby="daily-tab">
            <div class="row">
                <!-- Checklist Column (Full Width now) -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white py-3 border-bottom">
                            <h6 class="m-0 font-weight-bold text-primary">Itens de Verificação</h6>
                        </div>
                        <div class="card-body">
                            {% if checklist %}
                                {% if checklist.template %}
                                    <div class="alert alert-info mb-4 d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fas fa-info-circle me-2"></i>
                                            Modelo utilizado: <strong>{{ checklist.template.name }}</strong> ({{ checklist.template.department }})
                                        </div>
                                        <form method="post" class="m-0" onsubmit="return confirm('Tem certeza? Isso apagará o preenchimento atual e permitirá escolher outro modelo.');">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="reset">
                                            <button type="submit" class="btn btn-sm btn-outline-info bg-white text-info border-info">
                                                <i class="fas fa-sync-alt me-1"></i> Trocar Modelo
                                            </button>
                                        </form>
                                    </div>
                                {% endif %}

                                <form method="post" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    {{ formset.management_form }}
                                    
                                    <div class="list-group list-group-flush mb-4">
                                        {% for form in formset %}
                                            <div class="list-group-item px-0 border-bottom">
                                                {{ form.id }}
                                                <div class="row">
                                                    <div class="col-12 mb-3">
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="form-check form-switch me-3">
                                                                {{ form.is_checked }}
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <label class="form-label small text-muted text-uppercase fw-bold mb-1">Título da Atividade</label>
                                                                {{ form.title }}
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="form-label small text-muted mb-1">Descrição da Tarefa</label>
                                                            {{ form.description }}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row ps-4">
                                                    <div class="col-md-7">
                                                        <label class="form-label small text-muted mb-1">Observações Adicionais</label>
                                                        {{ form.observation }}
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label small text-muted mb-1">Fotos Comprobatórias</label>
                                                        
                                                        <!-- File Input -->
                                                        <div class="mb-2">
                                                            {{ form.new_images }}
                                                            <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">Selecione uma ou várias imagens (Ctrl+Click)</small>
                                                        </div>

                                                        <!-- Thumbnails Display -->
                                                        {% if form.instance.images.exists %}
                                                            <div class="d-flex flex-wrap gap-2 mt-2">
                                                                {% for img in form.instance.images.all %}
                                                                    <a href="{{ img.image.url }}" target="_blank" class="d-block border rounded position-relative" style="width: 50px; height: 50px; overflow: hidden;">
                                                                        <img src="{{ img.image.url }}" class="w-100 h-100" style="object-fit: cover;" title="Ver imagem">
                                                                    </a>
                                                                {% endfor %}
                                                            </div>
                                                        {% elif form.instance.image %}
                                                            <!-- Legacy single image fallback -->
                                                            <div class="d-flex flex-wrap gap-2 mt-2">
                                                                <a href="{{ form.instance.image.url }}" target="_blank" class="d-block border rounded position-relative" style="width: 50px; height: 50px; overflow: hidden;">
                                                                    <img src="{{ form.instance.image.url }}" class="w-100 h-100" style="object-fit: cover;" title="Ver imagem">
                                                                </a>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                
                                                {% if form.errors %}
                                                    <div class="alert alert-danger mt-2 ms-4">
                                                        {{ form.errors }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="submit" class="btn btn-primary px-4">
                                            <i class="fas fa-save me-2"></i>Salvar Checklist
                                        </button>
                                    </div>
                                </form>
                            {% else %}
                                <!-- No changes to template selection part -->
                                <div class="text-center py-4">
                                    <i class="fas fa-clipboard-list fa-3x text-gray-300 mb-3"></i>
                                    <h5>Iniciar Checklist Diário</h5>
                                    <p class="text-muted mb-4">Selecione um modelo abaixo para começar suas atividades de hoje.</p>
                                    
                                    <div class="row g-3 justify-content-center">
                                        {% for template in available_templates %}
                                            <div class="col-md-6">
                                                <div class="card h-100 border hover-shadow transition">
                                                    <div class="card-body">
                                                        <h6 class="card-title fw-bold text-primary">{{ template.name }}</h6>
                                                        <p class="card-text small text-muted mb-3">{{ template.department }}</p>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="badge bg-light text-dark border">{{ template.item_count }} Itens</span>
                                                            <form method="post" class="d-inline">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="template_id" value="{{ template.id }}">
                                                                <button type="submit" class="btn btn-sm btn-outline-primary">
                                                                    Iniciar <i class="fas fa-arrow-right ms-1"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% empty %}
                                            <div class="col-12">
                                                <div class="alert alert-warning">
                                                    Nenhum modelo de checklist disponível. Entre em contato com o administrador.
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Activities Section (Moved to bottom) -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-success">Atividades do Sistema</h6>
                            <span class="badge bg-success">{{ tickets_activities.count }} atividades hoje</span>
                        </div>
                        <div class="card-body p-0">
                             {% if tickets_activities %}
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 align-middle">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="ps-4">ID</th>
                                                <th>Cliente</th>
                                                <th>Descrição</th>
                                                <th>Status</th>
                                                <th>Horário</th>
                                                <th class="text-end pe-4">Ação</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ticket in tickets_activities %}
                                                <tr>
                                                    <td class="ps-4 fw-bold text-primary">#{{ ticket.formatted_id }}</td>
                                                    <td>{{ ticket.client.name|truncatechars:30 }}</td>
                                                    <td>{{ ticket.description|truncatechars:50 }}</td>
                                                    <td>
                                                        <span class="badge {% if ticket.status == 'open' %}bg-primary{% elif ticket.status == 'in_progress' %}bg-warning{% elif ticket.status == 'finished' %}bg-success{% else %}bg-secondary{% endif %}">
                                                            {{ ticket.get_status_display }}
                                                        </span>
                                                    </td>
                                                    <td class="text-muted small">{{ ticket.updated_at|date:"H:i" }}</td>
                                                    <td class="text-end pe-4">
                                                        <a href="{% url 'ticket_detail' ticket.id %}" class="btn btn-sm btn-outline-secondary">
                                                            Ver
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5 text-muted">
                                    <i class="fas fa-ghost fa-2x mb-2 opacity-50"></i>
                                    <p class="m-0 small">Nenhuma atividade registrada hoje.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Summary Card (Optional, or removed if redundant) -->
                    <!-- Keeping it simple as requested, just the activities table section -->
                </div>
            </div>
        </div>

        <!-- No Config Tab here; moved to Settings page -->
    </div>
</div>

<style>
    /* Custom styles for checklist inputs */
    .form-check-input {
        width: 2.5em;
        height: 1.25em;
        cursor: pointer;
    }
    textarea.form-control {
        font-size: 0.9rem;
        border-color: #e3e6f0;
        resize: vertical;
        min-height: 38px;
        height: 38px;
        transition: height 0.2s;
    }
    textarea.form-control:focus {
        height: 80px;
    }
</style>
{% endblock %}
