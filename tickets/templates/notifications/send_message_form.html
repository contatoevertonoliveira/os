{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 text-gray-800"><i class="fas fa-paper-plane me-2"></i>Nova Mensagem</h2>
        <a href="{% url 'notification_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <div class="card shadow mb-4" style="max-width: 800px; margin: 0 auto;">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <div class="row mb-3">
                    <div class="col-md-12">
                         <div class="form-check form-switch mb-3 p-3 bg-light rounded border">
                            {% render_field form.send_to_all class="form-check-input" id="sendToAllSwitch" style="margin-left: -2.5em; margin-right: 1em;" %}
                            <label class="form-check-label fw-bold" for="sendToAllSwitch" style="margin-left: 0.5em;">Enviar para todos (Mensagem Pública)</label>
                        </div>
                    </div>
                </div>

                <div class="row mb-3" id="recipientSection">
                    <div class="col-md-6">
                        <label for="{{ form.recipient.id_for_label }}" class="form-label">Destinatário Específico</label>
                        {% render_field form.recipient class="form-select select2" %}
                        {% if form.recipient.errors %}
                            <div class="invalid-feedback d-block">{{ form.recipient.errors|first }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.group.id_for_label }}" class="form-label">Ou Enviar para Grupo</label>
                        {% render_field form.group class="form-select" %}
                        {% if form.group.errors %}
                            <div class="invalid-feedback d-block">{{ form.group.errors|first }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.title.id_for_label }}" class="form-label">Assunto</label>
                    {% render_field form.title class="form-control" placeholder="Assunto da mensagem" %}
                    {% if form.title.errors %}
                        <div class="invalid-feedback d-block">{{ form.title.errors|first }}</div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.message.id_for_label }}" class="form-label">Mensagem</label>
                    {% render_field form.message class="form-control" rows="5" placeholder="Escreva sua mensagem aqui..." %}
                    {% if form.message.errors %}
                        <div class="invalid-feedback d-block">{{ form.message.errors|first }}</div>
                    {% endif %}
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane me-2"></i>Enviar Mensagem
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sendToAllSwitch = document.getElementById('sendToAllSwitch');
        const recipientSection = document.getElementById('recipientSection');
        const recipientSelect = document.querySelector('[name="recipient"]');
        const groupSelect = document.querySelector('[name="group"]');

        function toggleRecipientFields() {
            if (sendToAllSwitch.checked) {
                recipientSection.style.opacity = '0.5';
                recipientSection.style.pointerEvents = 'none';
                recipientSelect.value = '';
                groupSelect.value = '';
                // If using Select2, trigger change
                if (typeof $ !== 'undefined' && $(recipientSelect).data('select2')) {
                    $(recipientSelect).trigger('change');
                }
            } else {
                recipientSection.style.opacity = '1';
                recipientSection.style.pointerEvents = 'auto';
            }
        }

        sendToAllSwitch.addEventListener('change', toggleRecipientFields);
        toggleRecipientFields(); // Initial state
    });
</script>
{% endblock %}